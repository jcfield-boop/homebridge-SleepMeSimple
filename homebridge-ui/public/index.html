<!DOCTYPE html>
<html>
<head>
    <title>SleepMe Simple Configuration</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px; 
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-height: none;
            overflow: visible;
        }
        h1, h2, h3 {
            color: #333;
            text-align: center;
        }
        h1 {
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
        }
        h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input.invalid {
            border-color: #dc3545;
        }
        input[type="checkbox"] {
            width: auto;
        }
        button {
            background-color: #0070c9;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #00559b;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5a6268;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.edit {
            background-color: #28a745;
        }
        button.edit:hover {
            background-color: #218838;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .hidden {
            display: none;
        }
        .schedule-container {
            margin-top: 20px;
        }
        .schedule-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .schedule-form .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .schedule-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
        }
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .schedule-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .schedule-item-info {
            flex: 1;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        .error-text {
            color: #dc3545;
            font-size: 14px;
            margin-bottom: 5px;
            display: none;
        }
        .error-text.visible {
            display: block;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .template-section {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .template-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .template-col {
            flex: 1;
        }
        .template-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .info-card {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .info-card h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #0070c9;
        }
        .info-card p {
            margin: 0;
            font-size: 14px;
        }
        .section-divider {
            border-top: 1px solid #eee;
            margin: 25px 0 15px;
        }
        .schedule-group {
            margin-bottom: 20px;
            border-left: 3px solid #0070c9;
            padding-left: 10px;
        }
        .schedule-group-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #0070c9;
        }
        .schedule-phase {
            margin-left: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            color: white;
            display: inline-block;
            margin-right: 5px;
        }
        .phase-cooldown {
            background-color: #5bc0de;
        }
        .phase-deep {
            background-color: #0275d8;
        }
        .phase-rem {
            background-color: #5cb85c;
        }
        .phase-wakeup {
            background-color: #f0ad4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="icons/sleepmebasic.png" alt="SleepMe Simple" class="logo">
            <h1>SleepMe Simple Configuration</h1>
        </div>
        
        <div id="status" class="status hidden"></div>
        
        <form id="configForm">
            <div class="form-group">
                <label for="apiToken">API Token:</label>
                <input type="text" id="apiToken" name="apiToken" required>
            </div>
            
            <div class="form-group">
                <label for="unit">Temperature Unit:</label>
                <select id="unit" name="unit">
                    <option value="C">Celsius</option>
                    <option value="F">Fahrenheit</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pollingInterval">Polling Interval (seconds):</label>
                <input type="number" id="pollingInterval" name="pollingInterval" min="60" max="300" value="90">
            </div>
            
            <div class="form-group">
                <label for="logLevel">Log Level:</label>
                <select id="logLevel" name="logLevel">
                    <option value="normal">Normal</option>
                    <option value="debug">Debug</option>
                    <option value="verbose">Verbose</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enableSchedules" name="enableSchedules">
                    Enable Schedules
                </label>
            </div>
            
            <div class="button-group">
                <button type="button" id="testConnection">Test Connection</button>
                <button type="submit">Save Configuration</button>
            </div>
        </form>
    </div>
    
    <div id="schedulesContainer" class="container hidden">
        <h2>Temperature Schedules</h2>
        
        <div class="tabs">
            <div class="tab active" data-tab="manual">Manual Schedule</div>
            <div class="tab" data-tab="templates">Schedule Templates</div>
        </div>
        
        <!-- Manual Schedule Tab -->
        <div id="manualTab" class="tab-content active">
            <p>Create schedules to automatically adjust your device temperature.</p>
            
            <div class="schedule-form">
                <div class="form-group">
                    <label for="scheduleType">Schedule Type:</label>
                    <select id="scheduleType">
                        <option value="Everyday">Everyday</option>
                        <option value="Weekdays">Weekdays</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Specific Day">Specific Day</option>
                        <option value="Warm Hug">Warm Hug</option>
                    </select>
                </div>
                
                <div id="daySelectContainer" class="form-group hidden">
                    <label for="scheduleDay">Day:</label>
                    <select id="scheduleDay">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTime">Time (24h):</label>
                    <div id="timeError" class="error-text">Please enter a valid 24-hour time (HH:MM)</div>
                    <input type="text" id="scheduleTime" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="HH:MM" value="21:30" required>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTemperature">Temperature:</label>
                    <div id="tempError" class="error-text">Temperature must be between 55-115째F</div>
                    <input type="number" id="scheduleTemperature" min="13" max="46" step="0.5" value="23" required>
                </div>
                
                <button type="button" id="addSchedule">Add Schedule</button>
                <button type="button" id="cancelEdit" class="secondary hidden">Cancel</button>
            </div>
            
            <div id="warmHugInfo" class="info-card hidden">
                <h4>Warm Hug Feature</h4>
                <p>The Warm Hug feature gradually increases temperature over time, starting before the scheduled time, for a gentle wake-up experience.</p>
            </div>
        </div>
        
        <!-- Template Tab -->
        <div id="templatesTab" class="tab-content">
            <div class="info-card">
                <h4>About Schedule Templates</h4>
                <p>These templates are designed based on sleep science to optimize your sleep experience throughout the night. Choose a template for weekdays and weekends to automatically create multiple schedule entries.</p>
            </div>
            
            <div class="template-section">
                <h3>Weekday Template</h3>
                <div class="template-row">
                    <div class="template-col">
                        <label for="weekdayTemplate">Select Template:</label>
                        <select id="weekdayTemplate">
                            <option value="">None</option>
                            <option value="optimal">Optimal Sleep Cycle</option>
                            <option value="nightOwl">Night Owl</option>
                            <option value="earlyBird">Early Bird</option>
                        </select>
                    </div>
                </div>
                <div id="weekdayTemplateDesc" class="template-desc"></div>
            </div>
            
            <div class="template-section">
                <h3>Weekend Template</h3>
                <div class="template-row">
                    <div class="template-col">
                        <label for="weekendTemplate">Select Template:</label>
                        <select id="weekendTemplate">
                            <option value="">None</option>
                            <option value="recovery">Weekend Recovery</option>
                            <option value="relaxed">Relaxed Weekend</option>
                        </select>
                    </div>
                </div>
                <div id="weekendTemplateDesc" class="template-desc"></div>
            </div>
            
            <div class="button-group">
                <button type="button" id="applyTemplates">Apply Templates</button>
            </div>
        </div>
        
        <div class="section-divider"></div>
        
        <div class="schedule-list">
            <h3>Current Schedules</h3>
            <div id="scheduleList"></div>
        </div>
    </div>
    <script>
    // Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', async () => {
    // Create a centralized error handler for better error tracking
    window.onerror = function(message, source, lineno, colno, error) {
        console.error(`UI Error: ${message} at ${source}:${lineno}:${colno}`, error);
        showStatus('An error occurred in the UI. See console for details.', true);
        return false;
    };

    // Track initialization state
    let initialized = false;
    
    // Check if the homebridge object is available (required for communication)
    if (typeof homebridge === 'undefined') {
        console.error('Homebridge UI object not available!');
        showStatus('Error: Homebridge UI framework not detected. Please reload the page.', true, false);
        return;
    }
    
    try {
        // Add a timeout to detect initialization problems
        const initTimeout = setTimeout(() => {
            if (!initialized) {
                console.error('UI initialization timed out');
                showStatus('UI initialization timeout. Try refreshing the page.', true, false);
            }
        }, 15000); // 15 second timeout
        
        // Listen for plugin events with proper error handling
        homebridge.addEventListener('event', async (data) => {
            try {
                console.log('Plugin event received:', data);
                if (data && data.event === 'config-updated') {
                    console.log('Config updated event received');
                    // Reload config on update event
                    await loadConfig();
                }
            } catch (error) {
                console.error('Error handling plugin event:', error);
                showStatus('Error processing server event: ' + error.message, true);
            }
        });
        
        console.log('SleepMe UI initialized');
        
        // Load initial configuration
        await loadConfig();
        
        // Mark as initialized and clear timeout
        initialized = true;
        clearTimeout(initTimeout);
        
    } catch (error) {
        console.error('Error initializing UI:', error);
        showStatus('Error initializing UI: ' + error.message, true, false);
    }
});
            
            
            // Get references to form elements
            const configForm = document.getElementById('configForm');
            const statusElement = document.getElementById('status');
            const testConnectionBtn = document.getElementById('testConnection');
            const enableSchedulesCheckbox = document.getElementById('enableSchedules');
            const schedulesContainer = document.getElementById('schedulesContainer');
            const scheduleTypeSelect = document.getElementById('scheduleType');
            const daySelectContainer = document.getElementById('daySelectContainer');
            const daySelect = document.getElementById('scheduleDay');
            const warmHugInfo = document.getElementById('warmHugInfo');
            const addScheduleBtn = document.getElementById('addSchedule');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const scheduleList = document.getElementById('scheduleList');
            const scheduleTimeInput = document.getElementById('scheduleTime');
            const scheduleTemperatureInput = document.getElementById('scheduleTemperature');
            const timeError = document.getElementById('timeError');
            const tempError = document.getElementById('tempError');
            const unitSelect = document.getElementById('unit');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const weekdayTemplateSelect = document.getElementById('weekdayTemplate');
            const weekendTemplateSelect = document.getElementById('weekendTemplate');
            const weekdayTemplateDesc = document.getElementById('weekdayTemplateDesc');
            const weekendTemplateDesc = document.getElementById('weekendTemplateDesc');
            const applyTemplatesBtn = document.getElementById('applyTemplates');
            
            // Schedule storage
            let schedules = [];
            
            // Track editing state
            let editingScheduleIndex = -1;
            let isEditing = false;
            
            // Template definitions
            const templates = {
                optimal: {
                    name: "Optimal Sleep Cycle",
                    description: "Designed for complete sleep cycles with REM enhancement",
                    schedules: [
                        { type: "Weekdays", time: "22:00", temperature: 21, description: "Cool Down - Helps you fall asleep faster" },
                        { type: "Weekdays", time: "23:00", temperature: 19, description: "Deep Sleep - Supports deeper sleep stages" },
                        { type: "Weekdays", time: "02:00", temperature: 23, description: "REM Support - Enhances REM sleep phases" },
                        { type: "Weekdays", time: "06:00", temperature: 25, description: "Warm Hug Wake-up - Gently wakes you with warmth" }
                    ]
                },
                nightOwl: {
                    name: "Night Owl",
                    description: "Later bedtime with extended morning warm-up",
                    schedules: [
                        { type: "Weekdays", time: "23:30", temperature: 21, description: "Cool Down" },
                        { type: "Weekdays", time: "00:30", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekdays", time: "03:30", temperature: 23, description: "REM Support" },
                        { type: "Weekdays", time: "07:30", temperature: 35, description: "Warm Hug Wake-up" }
                    ]
                },
                earlyBird: {
                    name: "Early Bird",
                    description: "Earlier bedtime and wake-up schedule",
                    schedules: [
                        { type: "Weekdays", time: "21:30", temperature: 21, description: "Cool Down" },
                        { type: "Weekdays", time: "22:00", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekdays", time: "01:00", temperature: 23, description: "REM Support" },
                        { type: "Weekdays", time: "06:00", temperature: 35, description: "Warm Hug Wake-up" }
                    ]
                },
                recovery: {
                    name: "Weekend Recovery",
                    description: "Extra sleep with later wake-up time",
                    schedules: [
                        { type: "Weekend", time: "23:00", temperature: 21, description: "Cool Down" },
                        { type: "Weekend", time: "00:00", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekend", time: "03:00", temperature: 23, description: "REM Support" },
                        { type: "Weekend", time: "08:00", temperature: 35, description: "Warm Hug Wake-up" }
                    ]
                },
                relaxed: {
                    name: "Relaxed Weekend",
                    description: "Gradual transitions for weekend leisure",
                    schedules: [
                        { type: "Weekend", time: "23:30", temperature: 22, description: "Cool Down" },
                        { type: "Weekend", time: "01:00", temperature: 20, description: "Deep Sleep" },
                        { type: "Weekend", time: "04:00", temperature: 24, description: "REM Support" },
                        { type: "Weekend", time: "09:00", temperature: 36, description: "Warm Hug Wake-up" }
                    ]
                }
            };
        
            // Enhanced showStatus with auto-hide option
            function showStatus(message, isError = false, autoHide = true) {
                statusElement.textContent = message;
                statusElement.className = isError ? 'status error' : 'status success';
                statusElement.classList.remove('hidden');
                
                // Auto-hide after delay if enabled
                if (autoHide) {
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 5000);
                }
            }
            
            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding tab content
                    const tabId = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // Toggle day select visibility based on schedule type
            scheduleTypeSelect.addEventListener('change', () => {
                const scheduleType = scheduleTypeSelect.value;
                
                // Show/hide day select for specific day schedules
                daySelectContainer.classList.toggle('hidden', scheduleType !== 'Specific Day');
                
                // Show/hide warm hug info
                warmHugInfo.classList.toggle('hidden', scheduleType !== 'Warm Hug');
            });
            
// Toggle schedule section visibility and reset schedules when disabled
enableSchedulesCheckbox.addEventListener('change', () => {
    console.log('Enable schedules checkbox changed:', enableSchedulesCheckbox.checked);
    
    // Toggle visibility of schedules container
    schedulesContainer.classList.toggle('hidden', !enableSchedulesCheckbox.checked);
    
    // If schedules are being disabled, clear the schedules array
    if (!enableSchedulesCheckbox.checked) {
        // Clear schedules when disabled to ensure clean state
        schedules = [];
        renderScheduleList(); // Update UI to reflect empty schedules
    }
});
            
            // Update template descriptions when a template is selected
            weekdayTemplateSelect.addEventListener('change', () => {
                const templateKey = weekdayTemplateSelect.value;
                if (templateKey && templates[templateKey]) {
                    const template = templates[templateKey];
                    weekdayTemplateDesc.textContent = `${template.name}: ${template.description}`;
                } else {
                    weekdayTemplateDesc.textContent = '';
                }
            });
            
            weekendTemplateSelect.addEventListener('change', () => {
                const templateKey = weekendTemplateSelect.value;
                if (templateKey && templates[templateKey]) {
                    const template = templates[templateKey];
                    weekendTemplateDesc.textContent = `${template.name}: ${template.description}`;
                } else {
                    weekendTemplateDesc.textContent = '';
                }
            });
            
            async function loadConfig() {
    try {
        console.log('Attempting to load configuration...');
        
        // Show loading indicator
        const statusElement = document.getElementById('status');
        statusElement.textContent = 'Loading configuration...';
        statusElement.className = 'status';
        statusElement.classList.remove('hidden');
        
        // Get configuration from Homebridge with timeout protection
        let config = {};
        
        try {
            // Make request to server with timeout
            const response = await Promise.race([
                homebridge.request('/config'),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout')), 10000)
                )
            ]);
            
            console.log('Config response:', response);
            
            if (response && response.success && response.config) {
                config = response.config;
                console.log('Loaded config:', config);
                
                // Hide loading message on success
                statusElement.classList.add('hidden');
            } else {
                console.warn('Could not load config from server:', response);
                statusElement.textContent = 'Using default configuration (could not load saved values)';
                statusElement.className = 'status warning';
                // Still hide after a delay
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 5000);
            }
        } catch (loadError) {
            console.error('Error loading config:', loadError);
            statusElement.textContent = 'Error loading configuration, using defaults';
            statusElement.className = 'status error';
            // Still hide after a delay
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }
        
        // Fill form with current values or defaults
        document.getElementById('apiToken').value = config.apiToken || '';
        document.getElementById('unit').value = config.unit || 'C';
        document.getElementById('pollingInterval').value = config.pollingInterval || 90;
        document.getElementById('logLevel').value = config.logLevel || 'normal';
        
        // Handle schedules
        const enableSchedules = !!config.enableSchedules;
        document.getElementById('enableSchedules').checked = enableSchedules;
        const schedulesContainer = document.getElementById('schedulesContainer');
        if (schedulesContainer) {
            schedulesContainer.classList.toggle('hidden', !enableSchedules);
        }

        // Load schedules only if enabled
        if (enableSchedules && Array.isArray(config.schedules)) {
            schedules = [...config.schedules]; // Create a fresh copy using spread operator
        } else {
            // Clear schedules array if disabled or not present
            schedules = [];
        }
        
        // Call renderScheduleList only if the function exists
        if (typeof renderScheduleList === 'function') {
            renderScheduleList();
        }
        
        // Call updateTemperatureValidation only if the function exists
        if (typeof updateTemperatureValidation === 'function') {
            updateTemperatureValidation();
        }
        
    } catch (error) {
        console.error('Error in loadConfig:', error);
        showStatus('Error loading configuration', true);
    }
}

// Handle form submission
configForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    console.log('Form submission started');
    
    // Validate required fields
    const apiToken = document.getElementById('apiToken').value.trim();
    if (!apiToken) {
        showStatus('API token is required', true);
        return;
    }
    
    // Validate polling interval is within range
    const pollingInterval = parseInt(document.getElementById('pollingInterval').value, 10);
    if (isNaN(pollingInterval) || pollingInterval < 60 || pollingInterval > 300) {
        showStatus('Polling interval must be between 60 and 300 seconds', true);
        return;
    }
    
    // Disable form elements during save
    const formElements = configForm.elements;
    for (let i = 0; i < formElements.length; i++) {
        formElements[i].disabled = true;
    }
    
    try {
        // Show saving indicator
        showStatus('Saving configuration...', false, false);
        
        // Build configuration object
        const config = {
            platform: "SleepMeSimple",
            name: 'SleepMe Simple',
            apiToken: apiToken,
            unit: document.getElementById('unit').value,
            pollingInterval: pollingInterval,
            logLevel: document.getElementById('logLevel').value,
            enableSchedules: document.getElementById('enableSchedules').checked
        };

        // Add schedules if enabled
        if (config.enableSchedules && schedules.length > 0) {
            config.schedules = schedules;
        }
        
        console.log('Config object ready:', config);
        
        // Create the body object with config property
        const requestBody = { config: config };
        
        console.log('Request body:', requestBody);
        
        // Send to server with timeout protection
        const response = await Promise.race([
            homebridge.request('/saveConfig', { 
                method: 'POST',
                body: requestBody  // Make sure body has config property
            }),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 15000)
            )
        ]);
        
        console.log('Save config response:', response);
        
        if (response && response.success) {
            showStatus('Configuration saved successfully!');
        } else {
            showStatus('Failed to save configuration: ' + (response?.error || 'Unknown error'), true);
        }
    } catch (error) {
        console.error('Form submission error:', error);
        showStatus('Error during save: ' + error.message, true);
    } finally {
        // Re-enable form elements
        console.log('Re-enabling form elements');
        for (let i = 0; i < formElements.length; i++) {
            formElements[i].disabled = false;
        }
    }
});
            
// Handle test connection button
testConnectionBtn.addEventListener('click', async () => {
    const apiToken = document.getElementById('apiToken').value.trim();
    
    if (!apiToken) {
        showStatus('API token is required', true);
        return;
    }
    
    // Update button state and show status
    testConnectionBtn.disabled = true;
    testConnectionBtn.textContent = 'Testing...';
    showStatus('Testing connection...', false, false);
    
    try {
        console.log('Sending test connection request...');
        const response = await Promise.race([
            homebridge.request('/device/test', {
                method: 'POST',
                body: { apiToken }
            }),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 15000)
            )
        ]);
        
        console.log('Test connection response:', response);
        
        if (response && response.success) {
            showStatus(response.message || 'Connection successful');
        } else {
            showStatus(response?.error || 'Connection failed', true);
        }
    } catch (error) {
        console.error('Test connection error:', error);
        showStatus(`Connection test failed: ${error.message}`, true);
    } finally {
        // Restore button state
        testConnectionBtn.disabled = false;
        testConnectionBtn.textContent = 'Test Connection';
    }
});
           
          // Apply templates
applyTemplatesBtn.addEventListener('click', () => {
    const weekdayKey = weekdayTemplateSelect.value;
    const weekendKey = weekendTemplateSelect.value;
    const currentUnit = unitSelect.value;
    
    let count = 0;
    
    if (weekdayKey && templates[weekdayKey]) {
        // Remove existing weekday schedules
        schedules = schedules.filter(s => s.type !== 'Weekdays');
        
        // Add new weekday schedules
        templates[weekdayKey].schedules.forEach(templateSchedule => {
            // Convert temperature if needed (templates are stored in Celsius)
            let adjustedTemp = templateSchedule.temperature;
            if (currentUnit === 'F') {
                adjustedTemp = Math.round(convertCtoF(adjustedTemp) * 10) / 10;
            }
            
            const schedule = {
                type: templateSchedule.type,
                time: templateSchedule.time,
                temperature: adjustedTemp,
                unit: currentUnit,
                description: templateSchedule.description
            };
            schedules.push(schedule);
            count++;
        });
    }
    
    if (weekendKey && templates[weekendKey]) {
        // Remove existing weekend schedules
        schedules = schedules.filter(s => s.type !== 'Weekend');
        
        // Add new weekend schedules
        templates[weekendKey].schedules.forEach(templateSchedule => {
            // Convert temperature if needed (templates are stored in Celsius)
            let adjustedTemp = templateSchedule.temperature;
            if (currentUnit === 'F') {
                adjustedTemp = Math.round(convertCtoF(adjustedTemp) * 10) / 10;
            }
            
            const schedule = {
                type: templateSchedule.type,
                time: templateSchedule.time,
                temperature: adjustedTemp,
                unit: currentUnit,
                description: templateSchedule.description
            };
            schedules.push(schedule);
            count++;
        });
    }
    
    // Update the UI
    renderScheduleList();
    
    if (count > 0) {
        showStatus(`Applied templates: added ${count} schedules`);
    } else {
        showStatus('No templates selected', true);
    }
});  
            // Validate time format (24h)
            scheduleTimeInput.addEventListener('input', validateScheduleTime);
            scheduleTimeInput.addEventListener('blur', validateScheduleTime);
            
            function validateScheduleTime() {
    const timePattern = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
    const value = scheduleTimeInput.value.trim();
    
    if (!value) {
        timeError.textContent = "Time is required";
        timeError.classList.add('visible');
        scheduleTimeInput.classList.add('invalid');
        return false;
    }
    
    const isValid = timePattern.test(value);
    
    // Show/hide error message
    timeError.textContent = isValid ? "" : "Please enter a valid 24-hour time (HH:MM)";
    timeError.classList.toggle('visible', !isValid);
    scheduleTimeInput.classList.toggle('invalid', !isValid);
    
    return isValid;
}

function validateTemperature() {
    const value = scheduleTemperatureInput.value.trim();
    const temp = parseFloat(value);
    const unit = unitSelect.value;
    
    if (!value) {
        tempError.textContent = "Temperature is required";
        tempError.classList.add('visible');
        scheduleTemperatureInput.classList.add('invalid');
        return false;
    }
    
    let isValid = true;
    let errorMsg = '';
    
    if (isNaN(temp)) {
        isValid = false;
        errorMsg = 'Please enter a valid number';
    } else if (unit === 'C' && (temp < 13 || temp > 46)) {
        isValid = false;
        errorMsg = 'Temperature must be between 13-46째C';
    } else if (unit === 'F' && (temp < 55 || temp > 115)) {
        isValid = false;
        errorMsg = 'Temperature must be between 55-115째F';
    }
    
    // Show/hide error message
    tempError.textContent = errorMsg;
    tempError.classList.toggle('visible', !isValid);
    scheduleTemperatureInput.classList.toggle('invalid', !isValid);
    
    return isValid;
}
            function updateTemperatureValidation() {
                const unit = unitSelect.value;
                // Update min/max attributes based on unit
                if (unit === 'C') {
                    scheduleTemperatureInput.setAttribute('min', '13');
                    scheduleTemperatureInput.setAttribute('max', '46');
                    if (!isEditing) {
                        scheduleTemperatureInput.value = '23';
                    }
                } else {
                    scheduleTemperatureInput.setAttribute('min', '55');
                    scheduleTemperatureInput.setAttribute('max', '115');
                    if (!isEditing) {
                        scheduleTemperatureInput.value = '73';
                    }
                }
                
                // Re-validate with new unit
                validateTemperature();
            }
            
            // Convert between Celsius and Fahrenheit
            function convertCtoF(celsius) {
                return (celsius * 9/5) + 32;
            }
            
            function convertFtoC(fahrenheit) {
                return (fahrenheit - 32) * 5/9;
            }
            
        // Function to enter edit mode for a schedule
function editSchedule(index) {
    // Validate index is within bounds
    if (index < 0 || index >= schedules.length) {
        console.error('Invalid schedule index:', index);
        showStatus('Error: Could not edit schedule (invalid index)', true);
        return;
    }

    // Set editing state
    isEditing = true;
    editingScheduleIndex = index;
    
    // Get the schedule to edit
    const schedule = schedules[index];
    
    // Set form values
    scheduleTypeSelect.value = schedule.type || 'Everyday';
    
    // Show day select container if needed
    if (schedule.type === 'Specific Day') {
        daySelectContainer.classList.remove('hidden');
        daySelect.value = schedule.day || '0';
    } else {
        daySelectContainer.classList.add('hidden');
    }
    
    // Show warm hug info if needed
    warmHugInfo.classList.toggle('hidden', schedule.type !== 'Warm Hug');
    
    // Set time with validation
    scheduleTimeInput.value = schedule.time || '21:30';
    validateScheduleTime();
    
    // Handle temperature based on unit conversion if needed
    const currentUnit = unitSelect.value;
    let displayTemp = schedule.temperature;
    
    try {
        // If temperature is stored in Celsius but we're displaying Fahrenheit
        if (schedule.unit === 'C' && currentUnit === 'F') {
            displayTemp = Math.round(convertCtoF(displayTemp) * 10) / 10;
        } 
        // If temperature is stored in Fahrenheit but we're displaying Celsius
        else if (schedule.unit === 'F' && currentUnit === 'C') {
            displayTemp = Math.round(convertFtoC(displayTemp) * 10) / 10;
        }
    } catch (error) {
        console.error('Error converting temperature during edit:', error);
        // Use original value if conversion fails
    }
    
    // Set temperature with validation
    scheduleTemperatureInput.value = displayTemp || 23;
    validateTemperature();
    
    // Change button text
    addScheduleBtn.textContent = 'Update Schedule';
    
    // Show cancel button
    cancelEditBtn.classList.remove('hidden');
}    
            
            // Function to exit edit mode
            function exitEditMode() {
                isEditing = false;
                editingScheduleIndex = -1;
                
                // Reset form
                scheduleTypeSelect.value = 'Everyday';
                daySelectContainer.classList.add('hidden');
                warmHugInfo.classList.add('hidden');
                scheduleTimeInput.value = '21:30';
                
                // Set default temperature based on current unit
                const unit = unitSelect.value;
                scheduleTemperatureInput.value = (unit === 'C') ? '23' : '73';
                
                // Reset button text
                addScheduleBtn.textContent = 'Add Schedule';
                
                // Hide cancel button
                cancelEditBtn.classList.add('hidden');
            }
            
            // Cancel edit button handler
            cancelEditBtn.addEventListener('click', exitEditMode);
            
          // Improved render schedule list with enhanced ordering and grouping
function renderScheduleList() {
    // Clear previous content
    scheduleList.innerHTML = '';
    
    // Display message if no schedules exist
    if (schedules.length === 0) {
        scheduleList.innerHTML = '<p>No schedules configured.</p>';
        return;
    }
    
    // Group schedules by type for better organization
    const groupedSchedules = {};
    
    // Populate groups
    schedules.forEach(schedule => {
        // Create group if it doesn't exist
        if (!groupedSchedules[schedule.type]) {
            groupedSchedules[schedule.type] = [];
        }
        groupedSchedules[schedule.type].push(schedule);
    });
    
    // Define sleep cycle phases for better categorization
    const phases = {
        COOL_DOWN: { name: 'Cool Down', weight: 10, class: 'phase-cooldown' },
        DEEP_SLEEP: { name: 'Deep Sleep', weight: 20, class: 'phase-deep' },
        REM: { name: 'REM Support', weight: 30, class: 'phase-rem' },
        WAKE_UP: { name: 'Wake-up', weight: 40, class: 'phase-wakeup' }
    };
    
    // Helper function to determine schedule phase by description and temperature
    function getSchedulePhase(schedule) {
        // Default to Cool Down if no description or temperature
        if (!schedule) return phases.COOL_DOWN;
        
        const desc = (schedule.description || '').toLowerCase();
        const temp = schedule.temperature;
        const unit = schedule.unit || 'C';
        
        // Normalize temperature to Celsius for consistent comparison
        const tempC = unit === 'C' ? temp : convertFtoC(temp);
        
        // Determine phase based on description keywords and temperature
        if (desc.includes('wake') || desc.includes('hug') || tempC > 30) {
            return phases.WAKE_UP;
        } else if (desc.includes('rem') || (tempC > 22 && tempC < 30)) {
            return phases.REM;
        } else if (desc.includes('deep') || tempC < 20) {
            return phases.DEEP_SLEEP;
        } else {
            return phases.COOL_DOWN;
        }
    }
    
    // Extract hour from time string for sorting
    function getTimeHour(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        return parseInt(parts[0], 10) || 0; // Return 0 if parsing fails
    }
    
    // Time period classification functions
    function isEveningTime(timeStr) {
        const hour = getTimeHour(timeStr);
        return hour >= 18 && hour <= 23;
    }
    
    function isEarlyMorningTime(timeStr) {
        const hour = getTimeHour(timeStr);
        return hour >= 0 && hour < 6;
    }
    
    function isMorningTime(timeStr) {
        const hour = getTimeHour(timeStr);
        return hour >= 6 && hour < 12;
    }
    
    // Process each group of schedules
    Object.keys(groupedSchedules).forEach(type => {
        // Create a group container
        const groupContainer = document.createElement('div');
        groupContainer.className = 'schedule-group';
        
        // Add group title
        const groupTitle = document.createElement('div');
        groupTitle.className = 'schedule-group-title';
        groupTitle.textContent = type;
        groupContainer.appendChild(groupTitle);
        
        // Group schedules by logical time periods
        const eveningSchedules = groupedSchedules[type].filter(s => isEveningTime(s.time));
        const earlyMorningSchedules = groupedSchedules[type].filter(s => isEarlyMorningTime(s.time));
        const morningSchedules = groupedSchedules[type].filter(s => isMorningTime(s.time));
        const otherSchedules = groupedSchedules[type].filter(s => 
            !isEveningTime(s.time) && !isEarlyMorningTime(s.time) && !isMorningTime(s.time));
        
        // Sort by time within each period
        const sortByTime = (a, b) => (a.time || '').localeCompare(b.time || '');
        eveningSchedules.sort(sortByTime);
        earlyMorningSchedules.sort(sortByTime);
        morningSchedules.sort(sortByTime);
        otherSchedules.sort(sortByTime);
        
        // Combine in natural sleep cycle order: evening (bedtime), early morning (deep sleep/REM), morning (wake up)
        const sortedSchedules = [
            ...eveningSchedules,
            ...earlyMorningSchedules,
            ...morningSchedules,
            ...otherSchedules
        ];
        
        // Create elements for each schedule
        sortedSchedules.forEach(schedule => {
            const scheduleItem = document.createElement('div');
            scheduleItem.className = 'schedule-item';
            
            // Determine the schedule phase for display formatting
            const phase = getSchedulePhase(schedule);
            
            // Format display info
            let displayInfo = '';
            
            // Add day name for specific day schedules
            if (schedule.type === 'Specific Day') {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayIndex = parseInt(schedule.day, 10);
                if (dayIndex >= 0 && dayIndex < days.length) {
                    displayInfo += `${days[dayIndex]} `;
                }
            }
            
            // Format temperature based on current selected unit
            let displayTemp = schedule.temperature;
            const currentUnit = unitSelect.value;
            
            try {
                // Handle unit conversion if needed
                if (schedule.unit === 'C' && currentUnit === 'F') {
                    displayTemp = Math.round(convertCtoF(displayTemp) * 10) / 10;
                } else if (schedule.unit === 'F' && currentUnit === 'C') {
                    displayTemp = Math.round(convertFtoC(displayTemp) * 10) / 10;
                }
                
                // Ensure displayTemp is a valid number
                if (isNaN(displayTemp)) {
                    displayTemp = schedule.temperature || 0;
                }
            } catch (error) {
                console.error('Error converting temperature:', error);
                displayTemp = schedule.temperature || 0;
            }
            
            // Format the time and temperature display
            displayInfo += `${schedule.time || '00:00'}: ${displayTemp}째${currentUnit}`;
            
            // Add phase label if not explicitly in description
            const hasPhaseInDesc = schedule.description && 
                (schedule.description.toLowerCase().includes(phase.name.toLowerCase()) || 
                 (phase.name === 'Wake-up' && schedule.description.toLowerCase().includes('hug')));
            
            // Create phase label
            const phaseLabel = document.createElement('span');
            phaseLabel.className = `schedule-phase ${phase.class}`;
            phaseLabel.textContent = hasPhaseInDesc ? 
                schedule.description : 
                (schedule.description || phase.name);
            
            // Store the global index for this schedule in the schedules array
            const globalIndex = schedules.indexOf(schedule);
            
            // Create schedule item elements
            const infoDiv = document.createElement('div');
            infoDiv.className = 'schedule-item-info';
            infoDiv.textContent = displayInfo + ' ';
            infoDiv.appendChild(phaseLabel);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'schedule-item-actions';
            
            // Create edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'edit';
            editBtn.textContent = 'Edit';
            editBtn.dataset.index = String(globalIndex);
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'danger';
            removeBtn.textContent = 'Remove';
            removeBtn.dataset.index = String(globalIndex);
            
            // Add buttons to actions div
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(removeBtn);
            
            // Add elements to schedule item
            scheduleItem.appendChild(infoDiv);
            scheduleItem.appendChild(actionsDiv);
            
            // Add event listeners for buttons
            editBtn.addEventListener('click', (event) => {
                const idx = parseInt(event.target.getAttribute('data-index'), 10);
                if (!isNaN(idx) && idx >= 0 && idx < schedules.length) {
                    editSchedule(idx);
                }
            });
            
            removeBtn.addEventListener('click', (event) => {
                const idx = parseInt(event.target.getAttribute('data-index'), 10);
                if (!isNaN(idx) && idx >= 0 && idx < schedules.length) {
                    // Confirm before removing
                    if (confirm('Are you sure you want to remove this schedule?')) {
                        schedules.splice(idx, 1);
                        renderScheduleList();
                    }
                }
            });
            
            // Add schedule item to group container
            groupContainer.appendChild(scheduleItem);
        });
        
        // Add group container to schedule list
        scheduleList.appendChild(groupContainer);
    });
}  // Add/Update schedule button handler
addScheduleBtn.addEventListener('click', () => {
    // Validate inputs first
    const isTimeValid = validateScheduleTime();
    const isTempValid = validateTemperature();
    
    if (!isTimeValid || !isTempValid) {
        showStatus('Please correct the errors in the schedule form', true);
        return;
    }
    
    const type = scheduleTypeSelect.value;
    const time = scheduleTimeInput.value;
    const temperature = parseFloat(scheduleTemperatureInput.value);
    const unit = unitSelect.value;
    
    // Validate required fields have values
    if (!type || !time || isNaN(temperature)) {
        showStatus('All schedule fields are required', true);
        return;
    }
    
    // Create schedule object
    const schedule = {
        type,
        time,
        temperature,
        unit
    };
    
    // Add day for specific day schedules
    if (type === 'Specific Day') {
        schedule.day = parseInt(document.getElementById('scheduleDay').value, 10);
    }
    
    // Add description for warm hug
    if (type === 'Warm Hug') {
        schedule.description = 'Warm Hug Wake-up';
    }
    
    try {
        if (isEditing) {
            // Validate editing index
            if (editingScheduleIndex < 0 || editingScheduleIndex >= schedules.length) {
                throw new Error('Invalid editing index');
            }
            
            // Update existing schedule
            schedules[editingScheduleIndex] = schedule;
            showStatus('Schedule updated');
            exitEditMode();
        } else {
            // Add new schedule
            schedules.push(schedule);
            
            // Reset form fields to default values
            scheduleTimeInput.value = '21:30';
            scheduleTemperatureInput.value = (unit === 'C') ? '23' : '73';
            
            showStatus('Schedule added');
        }
        
        // Update UI
        renderScheduleList();
    } catch (error) {
        console.error('Error saving schedule:', error);
        showStatus('Error saving schedule: ' + error.message, true);
    }
});
            
         
    </script>
</body>
</html>