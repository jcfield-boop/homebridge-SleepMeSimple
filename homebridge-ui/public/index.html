<!DOCTYPE html>
<html>
<head>
    <title>SleepMe Simple Configuration</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px; 
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-height: none;
            overflow: visible;
        }
        h1, h2, h3 {
            color: #333;
            text-align: center;
        }
        h1 {
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
        }
        h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input.invalid {
            border-color: #dc3545;
        }
        input[type="checkbox"] {
            width: auto;
        }
        button {
            background-color: #0070c9;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #00559b;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5a6268;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.edit {
            background-color: #28a745;
        }
        button.edit:hover {
            background-color: #218838;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .hidden {
            display: none;
        }
        .schedule-container {
            margin-top: 20px;
        }
        .schedule-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .schedule-form .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .schedule-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
        }
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .schedule-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .schedule-item-info {
            flex: 1;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        .error-text {
            color: #dc3545;
            font-size: 14px;
            margin-bottom: 5px;
            display: none;
        }
        .error-text.visible {
            display: block;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .template-section {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .template-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .template-col {
            flex: 1;
        }
        .template-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .info-card {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .info-card h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #0070c9;
        }
        .info-card p {
            margin: 0;
            font-size: 14px;
        }
        .section-divider {
            border-top: 1px solid #eee;
            margin: 25px 0 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="../icons/sleepmebasic.png" alt="SleepMe Simple" class="logo">
            <h1>SleepMe Simple Configuration</h1>
        </div>
        
        <div id="status" class="status hidden"></div>
        
        <form id="configForm">
            <div class="form-group">
                <label for="apiToken">API Token:</label>
                <input type="text" id="apiToken" name="apiToken" required>
            </div>
            
            <div class="form-group">
                <label for="unit">Temperature Unit:</label>
                <select id="unit" name="unit">
                    <option value="C">Celsius</option>
                    <option value="F">Fahrenheit</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pollingInterval">Polling Interval (seconds):</label>
                <input type="number" id="pollingInterval" name="pollingInterval" min="60" max="300" value="90">
            </div>
            
            <div class="form-group">
                <label for="logLevel">Log Level:</label>
                <select id="logLevel" name="logLevel">
                    <option value="normal">Normal</option>
                    <option value="debug">Debug</option>
                    <option value="verbose">Verbose</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enableSchedules" name="enableSchedules">
                    Enable Schedules
                </label>
            </div>
            
            <div class="button-group">
                <button type="button" id="testConnection">Test Connection</button>
                <button type="submit">Save Configuration</button>
            </div>
        </form>
    </div>
    
    <div id="schedulesContainer" class="container hidden">
        <h2>Temperature Schedules</h2>
        
        <div class="tabs">
            <div class="tab active" data-tab="manual">Manual Schedule</div>
            <div class="tab" data-tab="templates">Schedule Templates</div>
        </div>
        
        <!-- Manual Schedule Tab -->
        <div id="manualTab" class="tab-content active">
            <p>Create schedules to automatically adjust your device temperature.</p>
            
            <div class="schedule-form">
                <div class="form-group">
                    <label for="scheduleType">Schedule Type:</label>
                    <select id="scheduleType">
                        <option value="Everyday">Everyday</option>
                        <option value="Weekdays">Weekdays</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Specific Day">Specific Day</option>
                        <option value="Warm Hug">Warm Hug</option>
                    </select>
                </div>
                
                <div id="daySelectContainer" class="form-group hidden">
                    <label for="scheduleDay">Day:</label>
                    <select id="scheduleDay">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTime">Time (24h):</label>
                    <div id="timeError" class="error-text">Please enter a valid 24-hour time (HH:MM)</div>
                    <input type="text" id="scheduleTime" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="HH:MM" value="21:30" required>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTemperature">Temperature:</label>
                    <div id="tempError" class="error-text">Temperature must be between 55-115째F</div>
                    <input type="number" id="scheduleTemperature" min="13" max="46" step="0.5" value="23" required>
                </div>
                
                <button type="button" id="addSchedule">Add Schedule</button>
                <button type="button" id="cancelEdit" class="secondary hidden">Cancel</button>
            </div>
            
            <div id="warmHugInfo" class="info-card hidden">
                <h4>Warm Hug Feature</h4>
                <p>The Warm Hug feature gradually increases temperature over time, starting before the scheduled time, for a gentle wake-up experience.</p>
            </div>
        </div>
        
        <!-- Template Tab -->
        <div id="templatesTab" class="tab-content">
            <div class="info-card">
                <h4>About Schedule Templates</h4>
                <p>These templates are designed based on sleep science to optimize your sleep experience throughout the night. Choose a template for weekdays and weekends to automatically create multiple schedule entries.</p>
            </div>
            
            <div class="template-section">
                <h3>Weekday Template</h3>
                <div class="template-row">
                    <div class="template-col">
                        <label for="weekdayTemplate">Select Template:</label>
                        <select id="weekdayTemplate">
                            <option value="">None</option>
                            <option value="optimal">Optimal Sleep Cycle</option>
                            <option value="nightOwl">Night Owl</option>
                            <option value="earlyBird">Early Bird</option>
                        </select>
                    </div>
                </div>
                <div id="weekdayTemplateDesc" class="template-desc"></div>
            </div>
            
            <div class="template-section">
                <h3>Weekend Template</h3>
                <div class="template-row">
                    <div class="template-col">
                        <label for="weekendTemplate">Select Template:</label>
                        <select id="weekendTemplate">
                            <option value="">None</option>
                            <option value="recovery">Weekend Recovery</option>
                            <option value="relaxed">Relaxed Weekend</option>
                        </select>
                    </div>
                </div>
                <div id="weekendTemplateDesc" class="template-desc"></div>
            </div>
            
            <div class="button-group">
                <button type="button" id="applyTemplates">Apply Templates</button>
            </div>
        </div>
        
        <div class="section-divider"></div>
        
        <div class="schedule-list">
            <h3>Current Schedules</h3>
            <div id="scheduleList"></div>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('SleepMe UI initialized');
            
            // Get references to form elements
            const configForm = document.getElementById('configForm');
            const statusElement = document.getElementById('status');
            const testConnectionBtn = document.getElementById('testConnection');
            const enableSchedulesCheckbox = document.getElementById('enableSchedules');
            const schedulesContainer = document.getElementById('schedulesContainer');
            const scheduleTypeSelect = document.getElementById('scheduleType');
            const daySelectContainer = document.getElementById('daySelectContainer');
            const daySelect = document.getElementById('scheduleDay');
            const warmHugInfo = document.getElementById('warmHugInfo');
            const addScheduleBtn = document.getElementById('addSchedule');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const scheduleList = document.getElementById('scheduleList');
            const scheduleTimeInput = document.getElementById('scheduleTime');
            const scheduleTemperatureInput = document.getElementById('scheduleTemperature');
            const timeError = document.getElementById('timeError');
            const tempError = document.getElementById('tempError');
            const unitSelect = document.getElementById('unit');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const weekdayTemplateSelect = document.getElementById('weekdayTemplate');
            const weekendTemplateSelect = document.getElementById('weekendTemplate');
            const weekdayTemplateDesc = document.getElementById('weekdayTemplateDesc');
            const weekendTemplateDesc = document.getElementById('weekendTemplateDesc');
            const applyTemplatesBtn = document.getElementById('applyTemplates');
            
            // Schedule storage
            let schedules = [];
            
            // Track editing state
            let editingScheduleIndex = -1;
            let isEditing = false;
            
            // Template definitions
            const templates = {
                optimal: {
                    name: "Optimal Sleep Cycle",
                    description: "Designed for complete sleep cycles with REM enhancement",
                    schedules: [
                        { type: "Weekdays", time: "22:00", temperature: 21, description: "Cool Down - Helps you fall asleep faster" },
                        { type: "Weekdays", time: "23:00", temperature: 19, description: "Deep Sleep - Supports deeper sleep stages" },
                        { type: "Weekdays", time: "02:00", temperature: 23, description: "REM Support - Enhances REM sleep phases" },
                        { type: "Weekdays", time: "06:00", temperature: 25, description: "Warm Hug Wake-up - Gently wakes you with warmth" }
                    ]
                },
                nightOwl: {
                    name: "Night Owl",
                    description: "Later bedtime with extended morning warm-up",
                    schedules: [
                        { type: "Weekdays", time: "23:30", temperature: 21, description: "Cool Down" },
                        { type: "Weekdays", time: "00:30", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekdays", time: "03:30", temperature: 23, description: "REM Support" },
                        { type: "Weekdays", time: "07:30", temperature: 25, description: "Warm Hug Wake-up" }
                    ]
                },
                earlyBird: {
                    name: "Early Bird",
                    description: "Earlier bedtime and wake-up schedule",
                    schedules: [
                        { type: "Weekdays", time: "21:00", temperature: 21, description: "Cool Down" },
                        { type: "Weekdays", time: "22:00", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekdays", time: "01:00", temperature: 23, description: "REM Support" },
                        { type: "Weekdays", time: "05:00", temperature: 25, description: "Warm Hug Wake-up" }
                    ]
                },
                recovery: {
                    name: "Weekend Recovery",
                    description: "Extra sleep with later wake-up time",
                    schedules: [
                        { type: "Weekend", time: "23:00", temperature: 21, description: "Cool Down" },
                        { type: "Weekend", time: "00:00", temperature: 19, description: "Deep Sleep" },
                        { type: "Weekend", time: "03:00", temperature: 23, description: "REM Support" },
                        { type: "Weekend", time: "08:00", temperature: 25, description: "Warm Hug Wake-up" }
                    ]
                },
                relaxed: {
                    name: "Relaxed Weekend",
                    description: "Gradual transitions for weekend leisure",
                    schedules: [
                        { type: "Weekend", time: "23:30", temperature: 22, description: "Cool Down" },
                        { type: "Weekend", time: "01:00", temperature: 20, description: "Deep Sleep" },
                        { type: "Weekend", time: "04:00", temperature: 24, description: "REM Support" },
                        { type: "Weekend", time: "09:00", temperature: 26, description: "Warm Hug Wake-up" }
                    ]
                }
            };
            
            // Function to show status messages
            function showStatus(message, isError = false) {
                statusElement.textContent = message;
                statusElement.className = isError ? 'status error' : 'status success';
                statusElement.classList.remove('hidden');
                
                // Hide the message after 5 seconds
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 5000);
            }
            
            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding tab content
                    const tabId = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // Toggle day select visibility based on schedule type
            scheduleTypeSelect.addEventListener('change', () => {
                const scheduleType = scheduleTypeSelect.value;
                
                // Show/hide day select for specific day schedules
                daySelectContainer.classList.toggle('hidden', scheduleType !== 'Specific Day');
                
                // Show/hide warm hug info
                warmHugInfo.classList.toggle('hidden', scheduleType !== 'Warm Hug');
            });
            
            // Toggle schedule section visibility
            enableSchedulesCheckbox.addEventListener('change', () => {
                schedulesContainer.classList.toggle('hidden', !enableSchedulesCheckbox.checked);
            });
            
            // Update template descriptions when a template is selected
            weekdayTemplateSelect.addEventListener('change', () => {
                const templateKey = weekdayTemplateSelect.value;
                if (templateKey && templates[templateKey]) {
                    const template = templates[templateKey];
                    weekdayTemplateDesc.textContent = `${template.name}: ${template.description}`;
                } else {
                    weekdayTemplateDesc.textContent = '';
                }
            });
            
            weekendTemplateSelect.addEventListener('change', () => {
                const templateKey = weekendTemplateSelect.value;
                if (templateKey && templates[templateKey]) {
                    const template = templates[templateKey];
                    weekendTemplateDesc.textContent = `${template.name}: ${template.description}`;
                } else {
                    weekendTemplateDesc.textContent = '';
                }
            });
            
            // Apply templates
            applyTemplatesBtn.addEventListener('click', () => {
                const weekdayKey = weekdayTemplateSelect.value;
                const weekendKey = weekendTemplateSelect.value;
                
                let count = 0;
                
                if (weekdayKey && templates[weekdayKey]) {
                    // Remove existing weekday schedules
                    schedules = schedules.filter(s => s.type !== 'Weekdays');
                    
                    // Add new weekday schedules
                    templates[weekdayKey].schedules.forEach(templateSchedule => {
                        const schedule = {
                            type: templateSchedule.type,
                            time: templateSchedule.time,
                            temperature: templateSchedule.temperature,
                            unit: unitSelect.value,
                            description: templateSchedule.description
                        };
                        schedules.push(schedule);
                        count++;
                    });
                }
                
                if (weekendKey && templates[weekendKey]) {
                    // Remove existing weekend schedules
                    schedules = schedules.filter(s => s.type !== 'Weekend');
                    
                    // Add new weekend schedules
                    templates[weekendKey].schedules.forEach(templateSchedule => {
                        const schedule = {
                            type: templateSchedule.type,
                            time: templateSchedule.time,
                            temperature: templateSchedule.temperature,
                            unit: unitSelect.value,
                            description: templateSchedule.description
                        };
                        schedules.push(schedule);
                        count++;
                    });
                }
                
                // Update the UI
                renderScheduleList();
                
                if (count > 0) {
                    showStatus(`Applied templates: added ${count} schedules`);
                } else {
                    showStatus('No templates selected', true);
                }
            });
            
            // Validate time format (24h)
            scheduleTimeInput.addEventListener('input', validateScheduleTime);
            scheduleTimeInput.addEventListener('blur', validateScheduleTime);
            
            function validateScheduleTime() {
                const timePattern = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                const isValid = timePattern.test(scheduleTimeInput.value);
                
                // Show/hide error message
                timeError.classList.toggle('visible', !isValid);
                scheduleTimeInput.classList.toggle('invalid', !isValid);
                
                return isValid;
            }
            
            // Validate temperature based on selected unit
            scheduleTemperatureInput.addEventListener('input', validateTemperature);
            scheduleTemperatureInput.addEventListener('blur', validateTemperature);
            unitSelect.addEventListener('change', updateTemperatureValidation);
            
            function validateTemperature() {
                const temp = parseFloat(scheduleTemperatureInput.value);
                const unit = unitSelect.value;
                
                let isValid = true;
                let errorMsg = '';
                
                if (isNaN(temp)) {
                    isValid = false;
                    errorMsg = 'Please enter a valid number';
                } else if (unit === 'C' && (temp < 13 || temp > 46)) {
                    isValid = false;
                    errorMsg = 'Temperature must be between 13-46째C';
                } else if (unit === 'F' && (temp < 55 || temp > 115)) {
                    isValid = false;
                    errorMsg = 'Temperature must be between 55-115째F';
                }
                
                // Show/hide error message
                tempError.textContent = errorMsg;
                tempError.classList.toggle('visible', !isValid);
                scheduleTemperatureInput.classList.toggle('invalid', !isValid);
                
                return isValid;
            }
            
            function updateTemperatureValidation() {
                const unit = unitSelect.value;
                // Update min/max attributes based on unit
                if (unit === 'C') {
                    scheduleTemperatureInput.setAttribute('min', '13');
                    scheduleTemperatureInput.setAttribute('max', '46');
                    if (!isEditing) {
                        scheduleTemperatureInput.value = '23';
                    }
                } else {
                    scheduleTemperatureInput.setAttribute('min', '55');
                    scheduleTemperatureInput.setAttribute('max', '115');
                    if (!isEditing) {
                        scheduleTemperatureInput.value = '73';
                    }
                }
                
                // Re-validate with new unit
                validateTemperature();
            }
            
            // Convert between Celsius and Fahrenheit
            function convertCtoF(celsius) {
                return (celsius * 9/5) + 32;
            }
            
            function convertFtoC(fahrenheit) {
                return (fahrenheit - 32) * 5/9;
            }
            
            // Function to enter edit mode for a schedule
            function editSchedule(index) {
                // Set editing state
                isEditing = true;
                editingScheduleIndex = index;
                
                // Get the schedule to edit
                const schedule = schedules[index];
                
                // Set form values
                scheduleTypeSelect.value = schedule.type;
                
                // Show day select container if needed
                if (schedule.type === 'Specific Day') {
                    daySelectContainer.classList.remove('hidden');
                    daySelect.value = schedule.day;
                } else {
                    daySelectContainer.classList.add('hidden');
                }
                
                // Show warm hug info if needed
                warmHugInfo.classList.toggle('hidden', schedule.type !== 'Warm Hug');
                
                // Set time
                scheduleTimeInput.value = schedule.time;
                
                // Handle temperature based on unit conversion if needed
                const currentUnit = unitSelect.value;
                let displayTemp = schedule.temperature;
                
                // If temperature is stored in Celsius but we're displaying Fahrenheit
                if (schedule.unit === 'C' && currentUnit === 'F') {
                    displayTemp = Math.round(convertCtoF(schedule.temperature) * 10) / 10;
                } 
                // If temperature is stored in Fahrenheit but we're displaying Celsius
                else if (schedule.unit === 'F' && currentUnit === 'C') {
                    displayTemp = Math.round(convertFtoC(schedule.temperature) * 10) / 10;
                }
                
                scheduleTemperatureInput.value = displayTemp;
                
                // Change button text
                addScheduleBtn.textContent = 'Update Schedule';
                
                // Show cancel button
                cancelEditBtn.classList.remove('hidden');
            }
            
            // Function to exit edit mode
            function exitEditMode() {
                isEditing = false;
                editingScheduleIndex = -1;
                
                // Reset form
                scheduleTypeSelect.value = 'Everyday';
                daySelectContainer.classList.add('hidden');
                warmHugInfo.classList.add('hidden');
                scheduleTimeInput.value = '21:30';
                
                // Set default temperature based on current unit
                const unit = unitSelect.value;
                scheduleTemperatureInput.value = (unit === 'C') ? '23' : '73';
                
                // Reset button text
                addScheduleBtn.textContent = 'Add Schedule';
                
                // Hide cancel button
                cancelEditBtn.classList.add('hidden');
            }
            
            // Cancel edit button handler
            cancelEditBtn.addEventListener('click', exitEditMode);
            
            // Load current configuration
            async function loadConfig() {
                try {
                    // Get configuration from Homebridge
                    let config = {};
                    
                    try {
                        const response = await homebridge.request('/config');
                        
                        if (response && response.success && response.config) {
                            config = response.config;
                            console.log('Config loaded successfully');
                        } else {
                            console.warn('Could not load config from server, using defaults');
                        }
                    } catch (loadError) {
                        console.warn('Error loading config, using defaults:', loadError);
                        // Don't show error to user, just use defaults
                    }
                    
                    // Fill form with current values or defaults
                    document.getElementById('apiToken').value = config.apiToken || '';
                    document.getElementById('unit').value = config.unit || 'C';
                    document.getElementById('pollingInterval').value = config.pollingInterval || 90;
                    document.getElementById('logLevel').value = config.logLevel || 'normal';
                    
                    // Handle schedules
                    const enableSchedules = !!config.enableSchedules;
                    document.getElementById('enableSchedules').checked = enableSchedules;
                    schedulesContainer.classList.toggle('hidden', !enableSchedules);
                    
                    // Load schedules
                    schedules = Array.isArray(config.schedules) ? config.schedules : [];
                    renderScheduleList();
                    
                    // Update temperature validation based on unit
                    updateTemperatureValidation();
                    
                } catch (error) {
                    console.error('Error in loadConfig:', error);
                    // Don't show loading errors to user, just use defaults
                }
            }
            
            // Render the schedule list
            function renderScheduleList() {
                scheduleList.innerHTML = '';
                
                if (schedules.length === 0) {
                    scheduleList.innerHTML = '<p>No schedules configured.</p>';
                    return;
                }
                
                // Group schedules by type for better organization
                const groupedSchedules = {};
                
                schedules.forEach(schedule => {
                    if (!groupedSchedules[schedule.type]) {
                        groupedSchedules[schedule.type] = [];
                    }
                    groupedSchedules[schedule.type].push(schedule);
                });
                
                // Render each group
                Object.keys(groupedSchedules).forEach(type => {
                    const groupHeader = document.createElement('h4');
                    groupHeader.textContent = type;
                    groupHeader.style.marginTop = '15px';
                    groupHeader.style.marginBottom = '5px';
                    scheduleList.appendChild(groupHeader);
                    
                    // Sort schedules by time
                    const sortedSchedules = groupedSchedules[type].sort((a, b) => {
                        return a.time.localeCompare(b.time);
                    });
                    
                    sortedSchedules.forEach((schedule) => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        
                        // Format display info
                        let displayInfo = '';
                        
                        if (schedule.type === 'Specific Day') {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            displayInfo += `${days[schedule.day]} `;
                        }
                        
                        // Format temperature based on current selected unit
                        let displayTemp = schedule.temperature;
                        const currentUnit = unitSelect.value;
                        
                        // If temperature is stored in Celsius but we're displaying Fahrenheit
                        if (schedule.unit === 'C' && currentUnit === 'F') {
                            displayTemp = Math.round(convertCtoF(schedule.temperature) * 10) / 10;
                        } 
                        // If temperature is stored in Fahrenheit but we're displaying Celsius
                        else if (schedule.unit === 'F' && currentUnit === 'C') {
                            displayTemp = Math.round(convertFtoC(schedule.temperature) * 10) / 10;
                        }
                        
                        displayInfo += `${schedule.time}: ${displayTemp}째${currentUnit}`;
                        
                        // Add description if available
                        if (schedule.description) {
                            displayInfo += ` (${schedule.description})`;
                        }
                        
                        // Store the global index for this schedule
                        const globalIndex = schedules.indexOf(schedule);
                        
                        // Create schedule item content with Edit and Remove buttons
                        scheduleItem.innerHTML = `
                            <div class="schedule-item-info">${displayInfo}</div>
                            <div class="schedule-item-actions">
                                <button type="button" class="edit" data-index="${globalIndex}">Edit</button>
                                <button type="button" class="danger" data-index="${globalIndex}">Remove</button>
                            </div>
                        `;
                        
                        // Add event listener for edit button
                        scheduleItem.querySelector('button.edit').addEventListener('click', (event) => {
                            const idx = parseInt(event.target.getAttribute('data-index'), 10);
                            editSchedule(idx);
                        });
                        
                        // Add event listener for remove button
                        scheduleItem.querySelector('button.danger').addEventListener('click', (event) => {
                            const idx = parseInt(event.target.getAttribute('data-index'), 10);
                            schedules.splice(idx, 1);
                            renderScheduleList();
                        });
                        
                        scheduleList.appendChild(scheduleItem);
                    });
                });
            }
            
            // Add/Update schedule
            addScheduleBtn.addEventListener('click', () => {
                // Validate inputs first
                const isTimeValid = validateScheduleTime();
                const isTempValid = validateTemperature();
                
                if (!isTimeValid || !isTempValid) {
                    showStatus('Please correct the errors in the schedule form', true);
                    return;
                }
                
                const type = scheduleTypeSelect.value;
                const time = scheduleTimeInput.value;
                const temperature = parseFloat(scheduleTemperatureInput.value);
                const unit = unitSelect.value;
                
                // Create schedule object
                const schedule = {
                    type,
                    time,
                    temperature,
                    unit
                };
                
                // Add day for specific day schedules
                if (type === 'Specific Day') {
                    schedule.day = parseInt(document.getElementById('scheduleDay').value, 10);
                }
                
                if (isEditing) {
                    // Update existing schedule
                    schedules[editingScheduleIndex] = schedule;
                    showStatus('Schedule updated');
                    exitEditMode();
                } else {
                    // Add new schedule
                    schedules.push(schedule);
                    
                    // Reset form fields to default values
                    scheduleTimeInput.value = '21:30';
                    scheduleTemperatureInput.value = (unit === 'C') ? '23' : '73';
                    
                    showStatus('Schedule added');
                }
                
                // Update UI
                renderScheduleList();
            });
            
            // Save configuration
            async function saveConfig(formData) {
                try {
                    // Create config object from form data
                    const config = {
                        platform: "SleepMeSimple",
                        name: 'SleepMe Simple',
                        apiToken: formData.get('apiToken'),
                        unit: formData.get('unit'),
                        pollingInterval: parseInt(formData.get('pollingInterval'), 10),
                        logLevel: formData.get('logLevel'),
                        enableSchedules: formData.get('enableSchedules') === 'on'
                    };
                    
                    // Only include schedules if enabled
                    if (config.enableSchedules && schedules.length > 0) {
                        config.schedules = schedules;
                    }
                    
                    console.log('Saving config:', JSON.stringify(config));
                    
                    // Send to server - using direct plugin API method
                    try {
                        await homebridge.updatePluginConfig([config]);
                        showStatus('Configuration saved successfully!');
                    } catch (error) {
                        showStatus('Failed to save configuration: ' + error.message, true);
                    }
                } catch (error) {
                    showStatus('Error saving configuration: ' + error.message, true);
                }
            }
            
            // Test connection to SleepMe API
            async function testApiConnection() {
                try {
                    const apiToken = document.getElementById('apiToken').value;
                    
                    if (!apiToken) {
                        showStatus('API token is required to test connection', true);
                        return;
                    }
                    
                    showStatus('Testing connection...');
                    
                    const response = await homebridge.request('/device/test', { 
                        body: {
                            apiToken
                        }
                    });
                    
                    if (response.success) {
                        showStatus('Connection successful: ' + response.message);
                    } else {
                        showStatus('Connection failed: ' + (response.error || 'Unknown error'), true);
                    }
                } catch (error) {
                    showStatus('Error testing connection: ' + error.message, true);
                }
            }
            
            // Handle form submission
            configForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(configForm);
                await saveConfig(formData);
            });
            
            // Handle test connection button
            testConnectionBtn.addEventListener('click', testApiConnection);
            
            // Load initial configuration
            await loadConfig();
        });
    </script>
</body>
</html>