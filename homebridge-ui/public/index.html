<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SleepMe Simple Configuration</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .api-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 4px;
            background-color: var(--light-bg);
        }
        
        .api-status.success {
            background-color: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .api-status.error {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger-color);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        button, input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 0.5rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-sm {
            width: auto;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }
        
        .card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            margin: -15px -15px 15px;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            color: white;
            margin: 0;
        }
        
        .template-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .template-card.active {
            border: 2px solid var(--secondary-color);
        }
        
        .schedule-list {
            list-style: none;
        }
        
        .schedule-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-details {
            flex: 1;
        }
        
        .schedule-actions {
            display: flex;
            gap: 5px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Time Visualization */
        .time-line {
            width: 100%;
            height: 60px;
            background-color: var(--light-bg);
            border-radius: 4px;
            position: relative;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        
        .time-marker {
            position: absolute;
            height: 100%;
            top: 0;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .time-marker::before {
            content: '';
            width: 2px;
            height: 60%;
            background-color: var(--primary-color);
        }
        
        .time-marker span {
            font-size: 12px;
            margin-top: 3px;
        }
        
        .time-schedule {
            position: absolute;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SleepMe Simple Configuration</h1>
        
        <!-- API Status Indicator -->
        <div id="apiStatus" class="api-status">
            <div id="spinner" class="spinner"></div>
            <p id="statusMessage">Connecting to Homebridge...</p>
        </div>
        
        <!-- Main Configuration Form -->
        <section id="mainConfig">
            <h2>Device Configuration</h2>
            <div class="form-group">
                <label for="apiToken">API Token</label>
                <input type="password" id="apiToken" placeholder="Enter your SleepMe API token">
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="tempUnit">Temperature Unit</label>
                        <select id="tempUnit">
                            <option value="C">Celsius (°C)</option>
                            <option value="F">Fahrenheit (°F)</option>
                        </select>
                    </div>
                </div>
                
                <div class="col">
                    <div class="form-group">
                        <label for="pollingInterval">Polling Interval (seconds)</label>
                        <input type="number" id="pollingInterval" min="60" max="300" placeholder="90">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="enableSchedules">
                    <input type="checkbox" id="enableSchedules" style="width: auto; margin-right: 10px;">
                    Enable Temperature Scheduling
                </label>
            </div>
            
            <button id="saveConfig" class="btn">Save Configuration</button>
        </section>
        
        <!-- Schedule Templates Section -->
        <section id="scheduleTemplates" class="hidden">
            <h2>Schedule Templates</h2>
            <p>Select predefined templates based on sleep science to get started quickly.</p>
            
            <div class="row">
                <div class="col">
                    <h3>Weekday Templates</h3>
                    <div id="weekdayTemplates" class="template-container">
                        <!-- Templates will be added here by JavaScript -->
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="col">
                    <h3>Weekend Templates</h3>
                    <div id="weekendTemplates" class="template-container">
                        <!-- Templates will be added here by JavaScript -->
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <div class="row" style="margin-top: 20px;">
                <div class="col">
                    <button id="applyTemplates" class="btn">Apply Selected Templates</button>
                </div>
            </div>
        </section>
        
        <!-- Schedule Management Section -->
        <section id="scheduleManagement" class="hidden">
            <h2>Schedule Management</h2>
            
            <!-- Time Visualization -->
            <div class="card">
                <div class="card-header">
                    <h3>Schedule Timeline</h3>
                </div>
                <div class="time-line" id="timeline">
                    <!-- Time markers will be added here by JavaScript -->
                    <div class="time-marker" style="left: 0%"><span>6 PM</span></div>
                    <div class="time-marker" style="left: 25%"><span>9 PM</span></div>
                    <div class="time-marker" style="left: 50%"><span>12 AM</span></div>
                    <div class="time-marker" style="left: 75%"><span>3 AM</span></div>
                    <div class="time-marker" style="left: 100%"><span>6 AM</span></div>
                    
                    <!-- Schedule markers will be added here by JavaScript -->
                </div>
            </div>
            
            <!-- Schedule List -->
            <div class="card">
                <div class="card-header">
                    <h3>Current Schedules</h3>
                    <button id="addScheduleBtn" class="btn btn-sm">Add Schedule</button>
                </div>
                
                <ul id="scheduleList" class="schedule-list">
                    <!-- Schedules will be added here by JavaScript -->
                    <li class="schedule-item">
                        <div class="spinner"></div>
                    </li>
                </ul>
            </div>
        </section>
        
        <!-- Add/Edit Schedule Modal -->
        <section id="scheduleModal" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 id="scheduleModalTitle">Add Schedule</h3>
                </div>
                
                <div class="form-group">
                    <label for="scheduleType">Schedule Type</label>
                    <select id="scheduleType">
                        <option value="Everyday">Everyday</option>
                        <option value="Weekdays">Weekdays</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Specific Day">Specific Day</option>
                    </select>
                </div>
                
                <div class="form-group" id="specificDayGroup" style="display: none;">
                    <label for="specificDay">Day</label>
                    <select id="specificDay">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTime">Time</label>
                    <input type="time" id="scheduleTime" required>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTemp">Temperature (°C)</label>
                    <input type="number" id="scheduleTemp" min="13" max="46" step="0.5" required>
                </div>
                
                <div class="form-group">
                    <label for="scheduleDescription">Description (optional)</label>
                    <input type="text" id="scheduleDescription" placeholder="e.g., Cool Down, Deep Sleep">
                </div>
                
                <div class="row">
                    <div class="col">
                        <button id="cancelScheduleBtn" class="btn btn-danger">Cancel</button>
                    </div>
                    <div class="col">
                        <button id="saveScheduleBtn" class="btn btn-secondary">Save Schedule</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // DOM Elements
        const apiStatus = document.getElementById('apiStatus');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        
        // Form elements
        const apiTokenInput = document.getElementById('apiToken');
        const tempUnitSelect = document.getElementById('tempUnit');
        const pollingIntervalInput = document.getElementById('pollingInterval');
        const enableSchedulesCheckbox = document.getElementById('enableSchedules');
        const saveConfigBtn = document.getElementById('saveConfig');
        
        // Schedule sections
        const scheduleTemplatesSection = document.getElementById('scheduleTemplates');
        const scheduleManagementSection = document.getElementById('scheduleManagement');
        
        // Template containers
        const weekdayTemplatesContainer = document.getElementById('weekdayTemplates');
        const weekendTemplatesContainer = document.getElementById('weekendTemplates');
        const applyTemplatesBtn = document.getElementById('applyTemplates');
        
        // Schedule list
        const scheduleList = document.getElementById('scheduleList');
        const addScheduleBtn = document.getElementById('addScheduleBtn');
        const timeline = document.getElementById('timeline');
        
        // Schedule modal
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleModalTitle = document.getElementById('scheduleModalTitle');
        const scheduleType = document.getElementById('scheduleType');
        const specificDayGroup = document.getElementById('specificDayGroup');
        const specificDay = document.getElementById('specificDay');
        const scheduleTime = document.getElementById('scheduleTime');
        const scheduleTemp = document.getElementById('scheduleTemp');
        const scheduleDescription = document.getElementById('scheduleDescription');
        const cancelScheduleBtn = document.getElementById('cancelScheduleBtn');
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        
        // State variables
        let currentConfig = null;
        let selectedWeekdayTemplate = null;
        let selectedWeekendTemplate = null;
        let currentScheduleIndex = null;
        let isEditMode = false;
        
        // Initialize the application
        async function init() {
            try {
                // Load the configuration
                const configResponse = await homebridge.request('/config');
                
                if (configResponse.success) {
                    currentConfig = configResponse.config;
                    updateUIWithConfig(currentConfig);
                    
                    // Update API status
                    updateStatus(true, 'Connected to Homebridge');
                    
                    // Load schedule templates
                    await loadTemplates();
                } else {
                    updateStatus(false, 'Failed to load configuration: ' + configResponse.error);
                }
            } catch (error) {
                updateStatus(false, 'Error connecting to Homebridge: ' + error.message);
                console.error('Initialization error:', error);
            }
        }
        
        // Update the UI with the configuration
        function updateUIWithConfig(config) {
            apiTokenInput.value = config.apiToken || '';
            tempUnitSelect.value = config.unit || 'C';
            pollingIntervalInput.value = config.pollingInterval || 90;
            enableSchedulesCheckbox.checked = config.enableSchedules || false;
            
            // Show/hide schedule sections based on enableSchedules
            toggleScheduleSections();
            
            // Update schedule list if schedules exist
            if (config.schedules && Array.isArray(config.schedules)) {
                renderScheduleList(config.schedules);
                renderTimeline(config.schedules);
            }
        }
        
        // Toggle schedule sections based on enableSchedules checkbox
        function toggleScheduleSections() {
            if (enableSchedulesCheckbox.checked) {
                scheduleTemplatesSection.classList.remove('hidden');
                scheduleManagementSection.classList.remove('hidden');
            } else {
                scheduleTemplatesSection.classList.add('hidden');
                scheduleManagementSection.classList.add('hidden');
            }
        }
        
        // Update status message
        function updateStatus(success, message) {
            spinner.style.display = 'none';
            statusMessage.textContent = message;
            
            if (success) {
                apiStatus.className = 'api-status success';
            } else {
                apiStatus.className = 'api-status error';
            }
        }
        
        // Load schedule templates
        async function loadTemplates() {
            try {
                // Load weekday templates
                const weekdayResponse = await homebridge.request('/templates/weekday');
                if (weekdayResponse.success) {
                    renderTemplates(weekdayTemplatesContainer, weekdayResponse.templates, 'weekday');
                }
                
                // Load weekend templates
                const weekendResponse = await homebridge.request('/templates/weekend');
                if (weekendResponse.success) {
                    renderTemplates(weekendTemplatesContainer, weekendResponse.templates, 'weekend');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                updateStatus(false, 'Failed to load schedule templates');
            }
        }
        
        // Render templates in the specified container
        function renderTemplates(container, templates, type) {
            // Clear the container
            container.innerHTML = '';
            
            // Add templates
            templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'card template-card';
                card.dataset.id = template.id;
                card.dataset.type = type;
                
                card.innerHTML = `
                    <h3>${template.name}</h3>
                    <p>${template.description}</p>
                    <div>
                        <strong>Schedule:</strong>
                        <ul>
                            ${template.schedules.map(schedule => `
                                <li>${schedule.time} - ${schedule.temperature}°C (${schedule.description})</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
                card.addEventListener('click', () => selectTemplate(card, type, template));
                
                container.appendChild(card);
            });
        }
        
        // Select a template
        function selectTemplate(cardElement, type, template) {
            // Remove active class from all templates in the container
            const container = cardElement.parentElement;
            const allCards = container.querySelectorAll('.template-card');
            allCards.forEach(card => card.classList.remove('active'));
            
            // Add active class to selected template
            cardElement.classList.add('active');
            
            // Store selected template
            if (type === 'weekday') {
                selectedWeekdayTemplate = template.id;
            } else if (type === 'weekend') {
                selectedWeekendTemplate = template.id;
            }
        }
        
        // Render the schedule list
        function renderScheduleList(schedules) {
            // Clear the list
            scheduleList.innerHTML = '';
            
            // Add schedules
            if (schedules.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'schedule-item';
                emptyItem.innerHTML = '<p>No schedules configured. Add one to get started.</p>';
                scheduleList.appendChild(emptyItem);
                return;
            }
            
            schedules.forEach((schedule, index) => {
                const item = document.createElement('li');
                item.className = 'schedule-item';
                
                let typeDisplay = schedule.type;
                if (schedule.type === 'Specific Day' && schedule.day) {
                    typeDisplay += ` (${schedule.day})`;
                }
                
                item.innerHTML = `
                    <div class="schedule-details">
                        <strong>${schedule.time} - ${schedule.temperature}°C</strong>
                        <div>${typeDisplay}${schedule.description ? ` - ${schedule.description}` : ''}</div>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn btn-sm edit-btn" data-index="${index}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">Delete</button>
                    </div>
                `;
                
                scheduleList.appendChild(item);
            });
            
            // Add event listeners for edit and delete buttons
            scheduleList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editSchedule(parseInt(btn.dataset.index)));
            });
            
            scheduleList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteSchedule(parseInt(btn.dataset.index)));
            });
        }
        
        // Render the schedule timeline
        function renderTimeline(schedules) {
            // Clear existing schedule markers
            const existingMarkers = timeline.querySelectorAll('.time-schedule');
            existingMarkers.forEach(marker => marker.remove());
            
            // Constants for time conversion
            const startHour = 18; // 6 PM
            const endHour = 6;    // 6 AM
            const totalHours = 12; // 12 hour span
            
            schedules.forEach((schedule, index) => {
                // Parse time
                const [hours, minutes] = schedule.time.split(':').map(Number);
                
                // Calculate position percentage
                let hourPosition;
                if (hours >= startHour) {
                    // Between 6 PM and midnight
                    hourPosition = (hours - startHour) / totalHours;
                } else {
                    // Between midnight and 6 AM
                    hourPosition = (hours + 24 - startHour) / totalHours;
                }
                
                // Add minutes contribution
                hourPosition += (minutes / 60) / totalHours;
                
                // Constrain to timeline width
                const position = Math.min(Math.max(hourPosition * 100, 0), 100);
                
                // Determine color based on temperature
                const tempNormalized = (schedule.temperature - 13) / (46 - 13); // Normalize between min and max temp
                const hue = 240 - (tempNormalized * 240); // From blue (240) to red (0)
                const backgroundColor = `hsl(${hue}, 100%, 50%)`;
                
                // Create schedule marker
                const marker = document.createElement('div');
                marker.className = 'time-schedule';
                marker.style.left = `${position}%`;
                marker.style.backgroundColor = backgroundColor;
                marker.dataset.index = index;
                marker.title = `${schedule.time} - ${schedule.temperature}°C${schedule.description ? ` (${schedule.description})` : ''}`;
                marker.textContent = index + 1;
                
                marker.addEventListener('click', () => editSchedule(index));
                
                timeline.appendChild(marker);
            });
        }
        
        // Edit a schedule
        function editSchedule(index) {
            const schedule = currentConfig.schedules[index];
            
            // Set modal title
            scheduleModalTitle.textContent = 'Edit Schedule';
            isEditMode = true;
            currentScheduleIndex = index;
            
            // Populate form
            scheduleType.value = schedule.type;
            scheduleTime.value = schedule.time;
            scheduleTemp.value = schedule.temperature;
            scheduleDescription.value = schedule.description || '';
            
            // Handle specific day
            toggleSpecificDayField();
            if (schedule.type === 'Specific Day' && schedule.day) {
                specificDay.value = schedule.day;
            }
            
            // Show modal
            scheduleModal.classList.remove('hidden');
        }
        
        // Delete a schedule
        async function deleteSchedule(index) {
            if (!confirm('Are you sure you want to delete this schedule?')) {
                return;
            }
            
            try {
                const response = await homebridge.request('/schedules/delete', { index });
                
                if (response.success) {
                    currentConfig.schedules = response.schedules;
                    renderScheduleList(currentConfig.schedules);
                    renderTimeline(currentConfig.schedules);
                    updateStatus(true, 'Schedule deleted successfully');
                } else {
                    updateStatus(false, 'Failed to delete schedule: ' + response.error);
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
                updateStatus(false, 'Error deleting schedule: ' + error.message);
            }
        }
        
        // Toggle the specific day field based on schedule type
        function toggleSpecificDayField() {
            if (scheduleType.value === 'Specific Day') {
                specificDayGroup.style.display = 'block';
            } else {
                specificDayGroup.style.display = 'none';
            }
        }
        
        // Handle form submissions and events
        function setupEventListeners() {
            // Enable schedules checkbox
            enableSchedulesCheckbox.addEventListener('change', toggleScheduleSections);
            
            // Save configuration
            saveConfigBtn.addEventListener('click', async () => {
                try {
                    // Validate form
                    if (!apiTokenInput.value) {
                        updateStatus(false, 'API token is required');
                        return;
                    }
                    
                    // Update configuration
                    currentConfig.apiToken = apiTokenInput.value;
                    currentConfig.unit = tempUnitSelect.value;
                    currentConfig.pollingInterval = parseInt(pollingIntervalInput.value) || 90;
                    currentConfig.enableSchedules = enableSchedulesCheckbox.checked;
                    
                    // Save the configuration
                    const response = await homebridge.request('/save-config', { config: currentConfig });
                    
                    if (response.success) {
                        updateStatus(true, 'Configuration saved successfully');
                    } else {
                        updateStatus(false, 'Failed to save configuration: ' + response.error);
                    }
                } catch (error) {
                    console.error('Error saving configuration:', error);
                    updateStatus(false, 'Error saving configuration: ' + error.message);
                }
            });
            
            // Apply templates
            applyTemplatesBtn.addEventListener('click', async () => {
                try {
                    // Apply weekday template if selected
                    if (selectedWeekdayTemplate) {
                        const weekdayResponse = await homebridge.request('/templates/apply', {
                            templateId: selectedWeekdayTemplate,
                            type: 'weekday'
                        });
                        
                        if (weekdayResponse.success) {
                            currentConfig.schedules = weekdayResponse.schedules;
                        } else {
                            updateStatus(false, 'Failed to apply weekday template: ' + weekdayResponse.error);
                            return;
                        }
                    }
                    
                    // Apply weekend template if selected
                    if (selectedWeekendTemplate) {
                        const weekendResponse = await homebridge.request('/templates/apply', {
                            templateId: selectedWeekendTemplate,
                            type: 'weekend'
                        });
                        
                        if (weekendResponse.success) {
                            currentConfig.schedules = weekendResponse.schedules;
                        } else {
                            updateStatus(false, 'Failed to apply weekend template: ' + weekendResponse.error);
                            return;
                        }
                    }
                    
                    // Update the UI
                    renderScheduleList(currentConfig.schedules);
                    renderTimeline(currentConfig.schedules);
                    updateStatus(true, 'Schedule templates applied successfully');
                } catch (error) {
                    console.error('Error applying templates:', error);
                    updateStatus(false, 'Error applying templates: ' + error.message);
                }
            });
            
            // Add schedule button
            addScheduleBtn.addEventListener('click', () => {
                // Reset form
                scheduleModalTitle.textContent = 'Add Schedule';
                isEditMode = false;
                currentScheduleIndex = null;
                
                scheduleType.value = 'Everyday';
                specificDayGroup.style.display = 'none';
                scheduleTime.value = '';
                scheduleTemp.value = '';
                scheduleDescription.value = '';
                
                // Show modal
                scheduleModal.classList.remove('hidden');
            });
            
            // Schedule type change
            scheduleType.addEventListener('change', toggleSpecificDayField);
            
            // Cancel schedule button
            cancelScheduleBtn.addEventListener('click', () => {
                scheduleModal.classList.add('hidden');
            });
            
            // Save schedule button
            saveScheduleBtn.addEventListener('click', async () => {
                try {
                    // Validate form
                    if (!scheduleTime.value || !scheduleTemp.value) {
                        updateStatus(false, 'Time and temperature are required');
                        return;
                    }
                    
                    // Prepare schedule object
                    const schedule = {
                        type: scheduleType.value,
                        time: scheduleTime.value,
                        temperature: parseFloat(scheduleTemp.value)
                    };
                    
                    // Add specific day if applicable
                    if (schedule.type === 'Specific Day') {
                        schedule.day = specificDay.value;
                    }
                    
                    // Add description if provided
                    if (scheduleDescription.value) {
                        schedule.description = scheduleDescription.value;
                    }
                    
                    let response;
                    if (isEditMode) {
                        // Update existing schedule
                        response = await homebridge.request('/schedules/update', {
                            index: currentScheduleIndex,
                            schedule
                        });
                    } else {
                        // Add new schedule
                        response = await homebridge.request('/schedules/add', { schedule });
                    }
                    
                    if (response.success) {
                        currentConfig.schedules = response.schedules;
                        renderScheduleList(currentConfig.schedules);
                        renderTimeline(currentConfig.schedules);
                        scheduleModal.classList.add('hidden');
                        updateStatus(true, isEditMode ? 'Schedule updated successfully' : 'Schedule added successfully');
                    } else {
                        updateStatus(false, 'Failed to save schedule: ' + response.error);
                    }
                } catch (error) {
                    console.error('Error saving schedule:', error);
                    updateStatus(false, 'Error saving schedule: ' + error.message);
                }
            });
        }
        
        // Call setup functions
        setupEventListeners();
        init();
    </script>
</body>
</html>